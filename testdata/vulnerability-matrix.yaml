# Vulnerability Test Matrix
# This file documents all 22 vulnerabilities (after removing K06:2 duplicate) with verification methods

vulnerabilities:
  # K01 - Insecure Workload Configurations
  - id: K01:0
    name: Privileged Container
    category: K01 - Insecure Workload Configurations
    programmatic_verification: |
      kubectl get deployment <target> -n <namespace> -o json | jq '.spec.template.spec.containers[0].securityContext.privileged == true'
    scanner_detectable: true
    scanner_control: kubescape C-0057 (Privileged container)
    tier: 1,2

  - id: K01:1
    name: Running as Root
    category: K01 - Insecure Workload Configurations
    programmatic_verification: |
      kubectl get deployment <target> -n <namespace> -o json | jq '.spec.template.spec.containers[0].securityContext.runAsUser == 0'
    scanner_detectable: true
    scanner_control: kubescape C-0013 (Non-root containers)
    tier: 1,2

  - id: K01:2
    name: Dangerous Capabilities
    category: K01 - Insecure Workload Configurations
    programmatic_verification: |
      kubectl get deployment <target> -n <namespace> -o json | jq '.spec.template.spec.containers[0].securityContext.capabilities.add[] | select(. == "SYS_ADMIN" or . == "NET_ADMIN")'
    scanner_detectable: true
    scanner_control: kubescape C-0046 (Insecure capabilities)
    tier: 1,2

  # K02 - Supply Chain Vulnerabilities
  - id: K02:0
    name: Vulnerable Node Image
    category: K02 - Supply Chain Vulnerabilities
    target: api
    vulnerable_image: node:10-alpine
    cve_count: 4
    programmatic_verification: |
      kubectl get deployment api -n <namespace> -o json | jq -r '.spec.template.spec.containers[0].image' | grep -q 'node:10-alpine'
    scanner_detectable: true
    scanner_control: trivy CRITICAL CVEs
    tier: 1,2,3

  - id: K02:1
    name: Vulnerable Nginx Image
    category: K02 - Supply Chain Vulnerabilities
    target: webapp
    vulnerable_image: nginx:1.15-alpine
    cve_count: 4
    programmatic_verification: |
      kubectl get deployment webapp -n <namespace> -o json | jq -r '.spec.template.spec.containers[0].image' | grep -q 'nginx:1.15-alpine'
    scanner_detectable: true
    scanner_control: trivy CRITICAL CVEs
    tier: 1,2

  - id: K02:2
    name: Vulnerable Python Image
    category: K02 - Supply Chain Vulnerabilities
    target: user-service
    vulnerable_image: python:3.5-alpine
    cve_count: 11
    programmatic_verification: |
      kubectl get deployment user-service -n <namespace> -o json | jq -r '.spec.template.spec.containers[0].image' | grep -q 'python:3.5-alpine'
    scanner_detectable: true
    scanner_control: trivy CRITICAL CVEs
    tier: 1,2,3

  - id: K02:3
    name: Vulnerable Ruby Image
    category: K02 - Supply Chain Vulnerabilities
    target: payment-service
    vulnerable_image: ruby:2.6-alpine
    cve_count: 4
    programmatic_verification: |
      kubectl get deployment payment-service -n <namespace> -o json | jq -r '.spec.template.spec.containers[0].image' | grep -q 'ruby:2.6-alpine'
    scanner_detectable: true
    scanner_control: trivy CRITICAL CVEs
    tier: 1,2

  - id: K02:4
    name: Vulnerable Grafana Image
    category: K02 - Supply Chain Vulnerabilities
    target: grafana
    vulnerable_image: grafana/grafana:9.0.0
    programmatic_verification: |
      kubectl get deployment grafana -n <namespace> -o json | jq -r '.spec.template.spec.containers[0].image' | grep -q 'grafana/grafana:9.0.0'
    scanner_detectable: true
    scanner_control: trivy CRITICAL CVEs
    tier: 1,2

  # K03 - Overly Permissive RBAC Configurations
  - id: K03:0
    name: Namespace Overpermissive RBAC
    category: K03 - Overly Permissive RBAC
    programmatic_verification: |
      kubectl get role <namespace>-overpermissive -n <namespace> 2>/dev/null && kubectl get rolebinding <namespace>-overpermissive-binding -n <namespace> 2>/dev/null
    scanner_detectable: true
    scanner_control: kubescape C-0053 (RBAC)
    tier: 1,2,3

  - id: K03:1
    name: Default Service Account Permissions
    category: K03 - Overly Permissive RBAC
    programmatic_verification: |
      kubectl get role <namespace>-default-permissions -n <namespace> 2>/dev/null && kubectl get rolebinding <namespace>-default-binding -n <namespace> 2>/dev/null
    scanner_detectable: true
    scanner_control: kubescape C-0053 (RBAC)
    tier: 1,2

  - id: K03:2
    name: Excessive Secrets Access
    category: K03 - Overly Permissive RBAC
    programmatic_verification: |
      kubectl get role <namespace>-secrets-reader -n <namespace> 2>/dev/null && kubectl get rolebinding <namespace>-secrets-binding -n <namespace> 2>/dev/null
    scanner_detectable: true
    scanner_control: kubescape C-0053 (RBAC)
    tier: 1,2

  # K06 - Broken Authentication (5 sub-issues after removing K06:2)
  - id: K06:0
    name: Default Service Account
    category: K06 - Broken Authentication
    programmatic_verification: |
      kubectl get deployment <target> -n <namespace> -o json | jq '.spec.template.spec.serviceAccountName == "" or .spec.template.spec.serviceAccountName == "default"'
    scanner_detectable: true
    scanner_control: kubescape C-0034 (Automatic mapping of service account)
    tier: 1,2,3

  - id: K06:1
    name: Auto-mount Service Account Token
    category: K06 - Broken Authentication
    programmatic_verification: |
      kubectl get deployment <target> -n <namespace> -o json | jq '.spec.template.spec.automountServiceAccountToken == true'
    scanner_detectable: true
    scanner_control: kubescape C-0034 (Automatic mapping of service account)
    tier: 1,2

  - id: K06:2
    name: Missing fsGroup
    category: K06 - Broken Authentication
    programmatic_verification: |
      kubectl get deployment <target> -n <namespace> -o json | jq '.spec.template.spec.securityContext.fsGroup == null'
    scanner_detectable: true
    scanner_control: kubescape C-0057 (Privileged container)
    tier: 1,2

  - id: K06:3
    name: Root User (duplicate K01:1 in different context)
    category: K06 - Broken Authentication
    programmatic_verification: |
      kubectl get deployment <target> -n <namespace> -o json | jq '.spec.template.spec.containers[0].securityContext.runAsUser == 0'
    scanner_detectable: true
    scanner_control: kubescape C-0013 (Non-root containers)
    tier: 1,2
    note: Intentional duplicate of K01:1 to demonstrate in authentication context

  - id: K06:4
    name: Privileged (duplicate K01:0 in different context)
    category: K06 - Broken Authentication
    programmatic_verification: |
      kubectl get deployment <target> -n <namespace> -o json | jq '.spec.template.spec.containers[0].securityContext.privileged == true'
    scanner_detectable: true
    scanner_control: kubescape C-0016 (Allow privilege escalation)
    tier: 1,2
    note: Intentional duplicate of K01:0 to demonstrate in authentication context

  # K07 - Missing Network Segmentation Controls
  - id: K07:0
    name: Missing NetworkPolicy
    category: K07 - Missing Network Segmentation Controls
    programmatic_verification: |
      ! kubectl get networkpolicy <target>-network-policy -n <namespace> 2>/dev/null
    scanner_detectable: true
    scanner_control: kubescape C-0260 (Missing network policy)
    tier: 1,2

  - id: K07:1
    name: Allow-all NetworkPolicy
    category: K07 - Missing Network Segmentation Controls
    programmatic_verification: |
      kubectl get networkpolicy <target>-allow-all -n <namespace> -o json | jq '.spec.ingress[0].from == [] and .spec.egress[0].to == []'
    scanner_detectable: true
    scanner_control: kubescape network controls
    tier: 1,2

  - id: K07:2
    name: NodePort Service Exposure
    category: K07 - Missing Network Segmentation Controls
    programmatic_verification: |
      kubectl get svc postgres-service -n <namespace> -o json | jq '.spec.type == "NodePort"'
    scanner_detectable: true
    scanner_control: kubescape (NodePort exposure)
    tier: 1,2,3

  - id: K07:3
    name: LoadBalancer Service Exposure
    category: K07 - Missing Network Segmentation Controls
    programmatic_verification: |
      kubectl get svc <target> -n <namespace> -o json | jq '.spec.type == "LoadBalancer"'
    scanner_detectable: true
    scanner_control: kubescape C-0209 (Exposed services)
    tier: 1,2

  # K08 - Secrets Management Failures
  - id: K08:0
    name: Secrets in ConfigMap
    category: K08 - Secrets Management Failures
    programmatic_verification: |
      kubectl get configmap <target>-config -n <namespace> -o json | jq '.data | to_entries[] | select(.value | contains("secret") or contains("password") or contains("key"))'
    scanner_detectable: true
    scanner_control: trivy/kubescape (Secrets in ConfigMap)
    tier: 1,2,3

  - id: K08:1
    name: Hardcoded Secrets in Env Vars
    category: K08 - Secrets Management Failures
    programmatic_verification: |
      kubectl get deployment <target> -n <namespace> -o json | jq '.spec.template.spec.containers[0].env[] | select(.value != null and (.name | contains("SECRET") or contains("PASSWORD") or contains("KEY")))'
    scanner_detectable: true
    scanner_control: trivy (Hardcoded secrets)
    tier: 1,2

  - id: K08:2
    name: Insecure Secret Volume Permissions
    category: K08 - Secrets Management Failures
    programmatic_verification: |
      kubectl get deployment <target> -n <namespace> -o json | jq '.spec.template.spec.volumes[] | select(.secret != null) | select(.secret.defaultMode == 420)' # 420 = 0644
    scanner_detectable: true
    scanner_control: kubescape C-0057 (Insecure volume permissions)
    tier: 1,2

# Tier 3 Representative Sample (6 tests)
representative_sample:
  - K01:0  # Privileged - most scanner-detectable
  - K02:2  # Python image - has 11 critical CVEs
  - K03:0  # Overpermissive RBAC - creates detectable RBAC
  - K06:0  # Default SA - programmatically verifiable
  - K07:2  # NodePort - service-level change
  - K08:0  # ConfigMap - creates detectable resource

# Statistics
total_vulnerabilities: 22
scanner_detectable: 22  # All after Phase 0 changes
programmatic_only: 0    # None after Phase 0 changes
categories:
  K01: 3
  K02: 5
  K03: 3
  K06: 5  # After removing K06:2 duplicate
  K07: 4
  K08: 3
